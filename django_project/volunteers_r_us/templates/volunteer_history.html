{% extends "base.html" %}
{% block title %}Volunteer History · VolunteersRUs{% endblock %}

{% block extra_css %}
<style>
  .page-title { font-weight:800; letter-spacing:.2px; }
  .card-soft { border:1px solid #eef0f4; border-radius:1rem; box-shadow:0 2px 10px rgba(17,24,39,.04); background:#fff; }
  .chip { display:inline-block; padding:.15rem .5rem; border-radius:999px; background:#eef2ff; color:#3730a3; font-size:.8rem; margin-right:.25rem; }
  .help { font-size:.85rem; color:#6b7280; }
  .container {
    max-width: 100% !important;
  }
  :root{
    --brand-blue: var(--bs-primary, #0d6efd);
    --row-alt: #f6f9ff;
    --row-hover: #eef5ff;
  }
  .table thead th {
    background: var(--brand-blue);
    color: #fff;
    font-weight: 700;
    letter-spacing: .2px;
    white-space: nowrap;
    padding: 1rem 1.25rem;
    border: none !important;
  }
  .table.themed-table thead th:first-child { border-top-left-radius: .8rem; }
  .table.themed-table thead th:last-child  { border-top-right-radius: .8rem; }
  .table.themed-table td { padding: 1rem 1.5rem; vertical-align: middle; word-wrap: break-word; border-top: 0; background: #fff; }
  .table.themed-table tbody tr { box-shadow: 0 2px 8px rgba(13,110,253,.06); }
  .table.themed-table tbody tr:nth-child(even) { background: var(--row-alt); }
  .table.themed-table tbody tr:hover { background: var(--row-hover); }

</style>
{% endblock %}

{% block content %}
<div class="container py-4">

  {% if messages %}
    <div class="mt-2">
      {% for message in messages %}
        <div class="alert alert-{{ message.tags|default:'info' }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    </div>
  {% endif %}

  <div class="row">
    <div class="col-12 px-4">
      <div class="d-flex align-items-center justify-content-between mb-2">
        <h1 class="page-title mb-0">Volunteer History</h1>
        {# Removed Add / Edit Participation button #}
      </div>
      <p class="text-secondary">
        Tabular display of all participation history. Data shown below is loaded dynamically from the VolunteerParticipation database table.
      </p>

      <!-- FILTERS -->
      <section class="card-soft p-3 p-md-4 mb-4">
        <form class="row g-3 align-items-end" id="filterForm" method="get" action="">
          <!-- Volunteer -->
          <div class="col-sm-6 filter-col">
            <label for="volunteer" class="form-label">Volunteer</label>
            <select id="volunteer" name="volunteer" class="form-select" aria-describedby="volHelp">
              <option value="" {% if not filter.volunteer %}selected{% endif %}>Any</option>
              {% for v in volunteers %}
                <option value="{{ v.id }}"
                        {% if filter.volunteer|stringformat:"s" == v.id|stringformat:"s" %}selected{% endif %}>
                  {{ v.full_name }}
                </option>
              {% endfor %}
            </select>
            <div id="volHelp" class="help">Choose a volunteer or leave as “Any”.</div>
          </div>

          <!-- Status -->
          <div class="col-sm-6 filter-col">
            <label for="status" class="form-label">Status</label>
            <select id="status" name="status" class="form-select">
              <option value="" {% if not filter.status %}selected{% endif %}>Any</option>
              {% for s in statuses %}
                <option value="{{ s }}" {% if filter.status == s %}selected{% endif %}>{{ s }}</option>
              {% endfor %}
            </select>
            <div class="help">Choose a status or leave as “Any”.</div>
          </div>

          <!-- Date -->
          <div class="col-sm-4">
            <label for="from_date" class="form-label">Date</label>
            <input id="from_date" name="from_date" type="date" class="form-control"
                  value="{{ filter.from_date|default:'' }}">
            <div class="help">Show events on or after this date.</div>
          </div>

          <!-- Actions -->
          <div class="col-12 d-flex gap-2">
            <button class="btn btn-primary" type="submit">Apply Filters</button>
            <a class="btn btn-outline-secondary" href="?reset=1" id="resetFilters">Reset</a>
          </div>
        </form>
      </section>

      <!-- TABLE -->
      <section class="card-soft p-0">
        <div class="table-wrap" style="max-height:60vh;">
          <table class="table align-middle mb-0" id="historyTable">
            <thead class="border-bottom">
              <tr>
                <th>Volunteer</th>
                <th>Event Name</th>
                <th>Description</th>
                <th>Location</th>
                <th>Required Skills</th>
                <th>Urgency</th>
                <th>Event Date</th>
                <th>Capacity</th>
                <th>Languages</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="historyBody">
              {% for r in rows %}
              <tr data-volunteer="{{ r.volunteer_id }}" data-status="{{ r.status }}">
                <td>{{ r.volunteer_name }}</td>
                <td>{{ r.event_name }}</td>
                <td>{{ r.description }}</td>
                <td>{{ r.location }}</td>
                <td>{% for s in r.required_skills %}<span class="chip">{{ s }}</span>{% endfor %}</td>
                <td>
                  {% if r.urgency == "High" %}
                    <span class="badge rounded-pill text-bg-warning">High</span>
                  {% elif r.urgency == "Medium" %}
                    <span class="badge rounded-pill text-bg-info">Medium</span>
                  {% else %}
                    <span class="badge rounded-pill text-bg-secondary">Low</span>
                  {% endif %}
                </td>
                <td>{% if r.event_date %}{{ r.event_date|date:"Y-m-d" }}{% else %}—{% endif %}</td>
                <td>{{ r.capacity }}</td>
                <td>{% for lang in r.languages %}<span class="chip">{{ lang }}</span>{% endfor %}</td>
                <td>
                  {% if r.status == "Registered" %}
                    <span class="badge rounded-pill bg-secondary">Registered</span>
                  {% elif r.status == "Attended" %}
                    <span class="badge rounded-pill text-bg-success">Attended</span>
                  {% elif r.status == "No-Show" %}
                    <span class="badge rounded-pill text-bg-danger">No-Show</span>
                  {% else %}
                    <span class="badge rounded-pill text-bg-dark">Cancelled</span>
                  {% endif %}
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="10" class="text-center text-secondary py-4">
                  No results found in the database.
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <div class="p-3 border-top d-flex justify-content-between align-items-center">
          <div class="text-secondary small">Showing {{ count }}</div>
          <div class="d-flex gap-2 ms-auto">
            <a class="btn btn-outline-secondary btn-sm"
              href="?export=1{% if filter.volunteer %}&volunteer={{ filter.volunteer|urlencode }}{% endif %}{% if filter.status %}&status={{ filter.status|urlencode }}{% endif %}{% if filter.from_date %}&from_date={{ filter.from_date|urlencode }}{% endif %}">
              Export csv
            </a>
            <button class="btn btn-outline-secondary btn-sm" type="button" onclick="window.print()">Print</button>
          </div>
        </div>
      </section>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
  const btn = document.getElementById('exportCsvBtn');
  if (!btn) return;
  btn.addEventListener('click', () => {
    const headers = Array.from(document.querySelectorAll('#historyTable thead th')).map(th => th.textContent.trim());
    const rows = Array.from(document.querySelectorAll('#historyBody tr'));
    const csv = [headers.map(h => `"${h}"`).join(',')]
      .concat(rows.map(tr => Array.from(tr.children).map(td => `"${td.textContent.trim().replace(/"/g, '""')}"`).join(',')))
      .join('\r\n');
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'volunteer_history.csv';
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  });
});
</script>
{% endblock %}
