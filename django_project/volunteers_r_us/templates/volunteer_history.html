{% extends "base.html" %}
{% block title %}Volunteer History · VolunteersRUs{% endblock %}

{% block extra_css %}
<style>
  .page-title { font-weight:800; letter-spacing:.2px; }
  .card-soft { border:1px solid #eef0f4; border-radius:1rem; box-shadow:0 2px 10px rgba(17,24,39,.04); background:#fff; }
  .chip { display:inline-block; padding:.15rem .5rem; border-radius:999px; background:#eef2ff; color:#3730a3; font-size:.8rem; margin-right:.25rem; }
  .table thead th { white-space:nowrap; }
  .table thead { position:sticky; top:0; background:#fff; z-index:1; }
  .help { font-size:.85rem; color:#6b7280; }
  .table-wrap { display:flex; justify-content:center; overflow-x:auto; }
  .table { width:auto; margin:0 auto; }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">

  {% if messages %}
    <div class="mt-2">
      {% for message in messages %}
        <div class="alert alert-{{ message.tags|default:'info' }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    </div>
  {% endif %}

  <div class="row justify-content-center">
    <div class="col-lg-10">
      <div class="d-flex align-items-center justify-content-between mb-2">
        <h1 class="page-title mb-0">Volunteer History</h1>
        <button class="btn btn-outline-primary btn-sm" type="button" data-bs-toggle="modal" data-bs-target="#addEditModal">
          Add / Edit Participation
        </button>
      </div>
      <p class="text-secondary">Tabular display of all participation history. Includes all Event Management fields and participation status.</p>

      <!-- FILTERS -->
      <section class="card-soft p-3 p-md-4 mb-4">
        <form class="row g-3 align-items-end" id="filterForm" method="get" action="">
          <!-- Volunteer -->
          <div class="col-sm-4">
            <label for="volunteer" class="form-label">Volunteer</label>
            <select id="volunteer" name="volunteer" class="form-select" aria-describedby="volHelp">
              <option value="" {% if not filter.volunteer %}selected{% endif %}>Any</option>
              {% for v in volunteers %}
                <option value="{{ v.id }}"
                        {% if filter.volunteer|stringformat:"s" == v.id|stringformat:"s" %}selected{% endif %}>
                  {{ v.full_name }} (ID {{ v.id }})
                </option>
              {% endfor %}
            </select>
            <div id="volHelp" class="help">Choose a specific volunteer or leave as “Any”.</div>
          </div>

          <!-- From date (STICKY VALUE + CORRECT NAME) -->
          <div class="col-sm-4">
            <label for="fromDate" class="form-label">From Date</label>
            <input
              id="fromDate"
              name="from_date"
              type="date"
              class="form-control"
              value="{{ filter.from_date }}"
              autocomplete="off"
              placeholder="mm/dd/yyyy"
            >
            <div class="help">Show participation starting from this date.</div>
          </div>

          <!-- Status -->
          <div class="col-sm-4">
            <label for="status" class="form-label">Status</label>
            <select id="status" name="status" class="form-select">
              <option value="" {% if not filter.status %}selected{% endif %}>Any</option>
              {% with fs=filter.status|default:'' %}
                {% for s in statuses %}
                  <option value="{{ s }}" {% if fs|lower == s|lower %}selected{% endif %}>{{ s }}</option>
                {% empty %}
                  <option>Registered</option>
                  <option>Attended</option>
                  <option>No-Show</option>
                  <option>Cancelled</option>
                {% endfor %}
              {% endwith %}
            </select>
          </div>

          <!-- Actions -->
          <div class="col-12 d-flex gap-2">
            <button class="btn btn-primary" type="submit">Apply Filters</button>
            <a class="btn btn-outline-secondary" href="?reset=1" id="resetFilters">Reset</a>
          </div>
        </form>
      </section>

      <!-- TABLE -->
      <section class="card-soft p-0">
        <div class="table-wrap" style="max-height:60vh;">
          <table class="table align-middle mb-0" id="historyTable">
            <thead class="border-bottom">
              <tr>
                <th>Volunteer</th>
                <th>Event Name</th>
                <th>Description</th>
                <th>Location</th>
                <th>Required Skills</th>
                <th>Urgency</th>
                <th>Event Date</th>
                <th>Capacity</th>
                <th>Languages</th>
                <th>Participation Status</th>
              </tr>
            </thead>
            <tbody id="historyBody">
              {% for r in rows %}
              <tr
                data-volunteer="{{ r.volunteer_id }}"
                data-status="{{ r.status }}"
                data-date="{% if r.event_date %}{{ r.event_date|date:'Y-m-d' }}{% endif %}"
              >
                <td>{{ r.volunteer_name }}</td>
                <td>{{ r.event_name }}</td>
                <td>{{ r.description }}</td>
                <td>{{ r.location }}</td>
                <td>
                  {% for s in r.required_skills %}
                    <span class="chip">{{ s }}</span>
                  {% endfor %}
                </td>
                <td>
                  {% if r.urgency == "High" %}
                    <span class="badge rounded-pill text-bg-warning">High</span>
                  {% elif r.urgency == "Medium" %}
                    <span class="badge rounded-pill text-bg-info">Medium</span>
                  {% else %}
                    <span class="badge rounded-pill text-bg-secondary">Low</span>
                  {% endif %}
                </td>
                <td>
                  {% if r.event_date %}
                    {{ r.event_date|date:"Y-m-d" }}
                  {% else %}
                    —
                  {% endif %}
                </td>
                <td>{{ r.capacity }}</td>
                <td>
                  {% for lang in r.languages %}
                    <span class="chip">{{ lang }}</span>
                  {% endfor %}
                </td>
                <td>
                  {% if r.status == "Registered" %}
                    <span class="badge rounded-pill bg-secondary">Registered</span>
                  {% elif r.status == "Attended" %}
                    <span class="badge rounded-pill text-bg-success">Attended</span>
                  {% elif r.status == "No-Show" %}
                    <span class="badge rounded-pill text-bg-danger">No-Show</span>
                  {% else %}
                    <span class="badge rounded-pill text-bg-dark">Cancelled</span>
                  {% endif %}
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="10" class="text-center text-secondary py-4">
                  No results match your filters.
                </td>
              </tr>
              {% endfor %}
            </tbody>

          </table>
        </div>

        <div class="p-3 border-top d-flex justify-content-between align-items-center">
          <div class="text-secondary small" id="resultCount">
            Showing {{ count }}
          </div>
          <div class="d-flex gap-2 ms-auto">
            <button class="btn btn-outline-secondary btn-sm" type="button" id="exportCsvBtn">Export CSV</button>
            <button class="btn btn-outline-secondary btn-sm" type="button" onclick="window.print()">Print</button>
          </div>
        </div>
      </section>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Simple CSV export
document.addEventListener('DOMContentLoaded', function () {
  const btn = document.getElementById('exportCsvBtn');
  if (!btn) return;
  btn.addEventListener('click', () => {
    const headers = Array.from(document.querySelectorAll('#historyTable thead th')).map(th => th.textContent.trim());
    const visibleRows = Array.from(document.querySelectorAll('#historyBody tr')).filter(tr => tr.style.display !== 'none');
    const data = visibleRows.map(tr => Array.from(tr.children).map(td => {
      const text = td.textContent.trim().replace(/\s+/g, ' ');
      return '"' + text.replace(/"/g,'""') + '"';
    }));
    const csv = [headers.map(h=>`"${h.replace(/"/g,'""')}"`).join(',')]
      .concat(data.map(row => row.join(',')))
      .concat('')
      .join('\r\n');
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'volunteer_history.csv';
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  });
});
</script>

<script>
// Submit to backend on change so filters combine and stay sticky
document.addEventListener('DOMContentLoaded', function () {
  const form = document.getElementById('filterForm');
  if (!form) return;

  form.addEventListener('change', function () {
    if (form.requestSubmit) form.requestSubmit(); else form.submit();
  });
});
</script>
{% endblock %}
