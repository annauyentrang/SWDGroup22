{% extends "base.html" %}
{% block title %}Volunteer Matching{% endblock %}
{% block content %}
<div class="row justify-content-center"><div class="col-lg-9">
  <h2 class="mb-3">Volunteer Matching</h2>

  <!-- Volunteer combo box (GET auto-submit) -->
  <form method="get" class="mb-3">
    <label class="form-label" for="volunteer_id">Volunteer</label>
    <select id="volunteer_id" name="volunteer_id" class="form-select" onchange="this.form.submit()">
      {% for v in volunteers %}
        <option value="{{ v.id }}" {% if v.id == volunteer.id %}selected{% endif %}>{{ v.name }}</option>
      {% endfor %}
    </select>
  </form>

  {% if errors %}
    <div class="alert alert-danger">{% for e in errors %}<div>{{ e }}</div>{% endfor %}</div>
  {% endif %}
  {% if saved %}
    <div class="alert alert-success">
      Assigned volunteer #{{ saved.volunteer_id }} to event #{{ saved.event_id }}{% if saved.notify %} (notify){% endif %}.
      Score {{ saved.match_score }} — {{ saved.match_reason }}.
      {% if saved.warnings %}<div>Warnings: {{ saved.warnings|join:", " }}</div>{% endif %}
      {% if saved.override %}<div>Override: {{ saved.override_reason }}</div>{% endif %}
      {% if saved.admin_notes %}<div>Notes: {{ saved.admin_notes }}</div>{% endif %}
    </div>
  {% endif %}

  <!-- Volunteer context badges -->
  <div class="card mb-3"><div class="card-body d-flex flex-wrap gap-3">
    <div><span class="text-muted">Selected:</span> <strong>{{ volunteer.name }}</strong> (ID {{ volunteer.id }})</div>
    <div><span class="text-muted">Skills:</span> {% for s in volunteer.skills %}<span class="badge text-bg-secondary me-1">{{ s }}</span>{% endfor %}</div>
    <div><span class="text-muted">Languages:</span> {% for l in volunteer.languages %}<span class="badge text-bg-secondary me-1">{{ l }}</span>{% endfor %}</div>
    <div><span class="text-muted">Availability:</span> {% for a in volunteer.availability %}<span class="badge text-bg-light border me-1">{{ a }}</span>{% endfor %}</div>
  </div></div>

  <!-- Insight -->
  <div class="card mb-3"><div class="card-body d-flex flex-wrap gap-3 align-items-center">
    <div><span class="text-muted">Suggested:</span> <span class="badge text-bg-primary">{{ suggested.title }}</span></div>
    <div><span class="text-muted">Score:</span> <strong>{{ match_score }}</strong></div>
    <div><span class="text-muted">Why:</span> {{ match_reason }}</div>
    {% if warnings and not saved %}<div class="w-100 mt-2">
      <div class="alert alert-warning mb-0 py-2">{% for w in warnings %}<div>• {{ w }}</div>{% endfor %}</div>
    </div>{% endif %}
  </div></div>

  <!-- Assignment form -->
  <form method="post" class="card">
    {% csrf_token %}
    <input type="hidden" name="volunteer_id" value="{{ volunteer.id }}">
    <div class="card-body">
      <div class="mb-3">
        <label class="form-label" for="matched_event">Matched Event</label>
        <select id="matched_event" name="matched_event" class="form-select" required>
          {% for e in events %}
            <option value="{{ e.id }}" {% if e.id == selected.id %}selected{% endif %}>{{ e.title }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="border rounded p-3">
        <div class="mb-2"><strong>{{ selected.title }}</strong></div>
        <div class="small text-muted">{{ selected.date }} · {{ selected.location }}</div>
      </div>

      <div class="form-check form-switch mt-3">
        <input class="form-check-input" type="checkbox" id="override" name="override">
        <label class="form-check-label" for="override">Override warnings</label>
      </div>
      <div class="mt-2">
        <label for="override_reason" class="form-label">Override reason</label>
        <textarea id="override_reason" name="override_reason" class="form-control" rows="2" placeholder="Explain why you're overriding" disabled></textarea>
      </div>
      <div class="mt-3">
        <label for="admin_notes" class="form-label">Admin notes</label>
        <textarea id="admin_notes" name="admin_notes" class="form-control" rows="2" placeholder="Optional"></textarea>
      </div>
    </div>
    <div class="card-footer d-flex justify-content-end gap-2">
      <a class="btn btn-outline-secondary" href="{% url 'home' %}">Skip</a>
      <button class="btn btn-primary" type="submit" name="action" value="assign">Assign</button>
      <button class="btn btn-success" type="submit" name="action" value="assign_notify">Assign + notify</button>
    </div>
  </form>

  <script>
  document.getElementById("override").addEventListener("change", function(){
    const ta = document.getElementById("override_reason");
    ta.disabled = !this.checked; if (!this.checked) ta.value="";
  });
  </script>
</div>
</div>

<button onclick="FENotify.push({message:'Assigned to Food Drive'})">
  Simulate Notification
</button>

{% endblock %}
